{% load i18n %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="baton-ai-stats">
    <h2>
        <span>Baton AI</span>
        <span>€ {{ budget }}</span>
    </h2>
    <div class="baton-ai-canvas-container">
        <canvas id="baton-ai-bar-stats"></canvas>
    </div>
    <script>
(function ($) {
    let aiChart;

    const drawChart = function (themeMode) {
        const textColor = themeMode === 'dark' ? '#fff' : '#000';
        const lightTextColor = themeMode === 'dark' ? '#e7e7e7' : '#010101';

        const ctx = document.getElementById('baton-ai-bar-stats');
        const today = new Date();
        const days = []
        const translations = {{ translations | safe}}
        const summarizations = {{ summarizations | safe}}
        const images = {{ images | safe}}
        for (let i = 0; i < 15; i++) {
            days.push(today.toISOString().slice(0, 10))
            today.setDate(today.getDate() - 1)
        }
        const totalCost = []
        const reversedDays = days.reverse()
        const translationsApiCalls = []
        const translationsApiPrice = []
        const summarizationsApiCalls = []
        const summarizationsApiPrice = []
        const imagesApiCalls = []
        const imagesApiPrice = []
        reversedDays.forEach((d, idx) => {
            translationsApiCalls.push(translations[d]?.count || 0)
            translationsApiPrice.push(translations[d]?.price || 0)
            summarizationsApiCalls.push(summarizations[d]?.count || 0)
            summarizationsApiPrice.push(summarizations[d]?.price || 0)
            imagesApiCalls.push(images[d]?.count || 0)
            imagesApiPrice.push(images[d]?.price || 0)
            totalCost.push(
                parseFloat(translations[d]?.price || 0) +
                parseFloat(summarizations[d]?.price || 0) +
                parseFloat(images[d]?.price || 0) +
                (idx === 0 ? 0 : totalCost[idx - 1])
            )
        })
        Chart.defaults.font.family = "Dosis"
        Chart.defaults.font.size = 14
        Chart.defaults.font.weight = 500

        aiChart = new Chart(ctx, {
            plugins: [{
                beforeInit(chart) {
                    // Get a reference to the original fit function
                    const originalFit = chart.legend.fit;

                    // Override the fit function
                    chart.legend.fit = function fit() {
                      // Call the original function and bind scope in order to use `this` correctly inside it
                      originalFit.bind(chart.legend)();
                      // Change the height as suggested in other answers
                      this.height += 15;
                    }
                }
            }],
            data: {
                labels: reversedDays.map(d => d.substr(5)),
                datasets: [{
                    type: 'bar',
                    label: Baton.T.get('TransApiCalls'),
                    data: translationsApiCalls,
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'bar',
                    label: Baton.T.get('TransApiCost'),
                    data: translationsApiPrice,
                    borderWidth: 1,
                    yAxisID: 'y1'
                },
                {
                    type: 'bar',
                    label: Baton.T.get('SummApiCalls'),
                    data: summarizationsApiCalls,
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'bar',
                    label: Baton.T.get('SummApiCost'),
                    data: summarizationsApiPrice,
                    borderWidth: 1,
                    yAxisID: 'y1'
                },
                {
                    type: 'bar',
                    label: Baton.T.get('ImagesApiCalls'),
                    data: imagesApiCalls,
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'bar',
                    label: Baton.T.get('ImagesApiCost'),
                    data: imagesApiPrice,
                    borderWidth: 1,
                    yAxisID: 'y1'
                },
                {
                    type: 'line',
                    label: Baton.T.get('TotalCost'),
                    data: totalCost,
                    borderWidth: 1,
                    yAxisID: 'y1',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: lightTextColor
                        },
                        title: {
                            display: true,
                            text: Baton.T.get('Date'),
                            font: {
                                weight: 700
                            },
                            color: textColor
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: lightTextColor
                        },
                        title: {
                            display: true,
                            text: Baton.T.get('Count'),
                            font: {
                                weight: 700
                            },
                            color: textColor
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        ticks: {
                            color: lightTextColor
                        },
                        title: {
                            display: true,
                            text: Baton.T.get('Cost') + ' (€)',
                            font: {
                                weight: 700
                            },
                            color: textColor
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: lightTextColor
                        }
                    }
                }
            }
        });
    }

    var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === "attributes") {
                const theme = $('html').attr('data-bs-theme');
                aiChart.destroy();
                drawChart(theme); 
            }
        });
    });

    observer.observe($('html')[0], {
      attributes: true //configure it to listen to attribute changes
    });

    drawChart($('html').attr('data-bs-theme'));
})(Baton.jQuery)
    </script>
</div>
